{% load static %}
<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>تفاصيل الباحث - {{ research.researcher_name }}</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
  <link rel="stylesheet" href="{% static 'core/css/app.css' %}">
  <style>
    /* الشكل القديم الأحلى */
    .researcher-header {
      background: linear-gradient(135deg, #e0f2fe 0%, #bae6fd 100%);
      padding: 3rem 2rem;
      text-align: center;
      border-radius: 0 0 24px 24px;
      margin-bottom: 2rem;
    }
    
    .researcher-avatar {
      width: 120px;
      height: 120px;
      background: #0284c7;
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 3rem;
      font-weight: 700;
      margin: 0 auto 1.5rem;
      box-shadow: 0 8px 24px rgba(2, 132, 199, 0.3);
    }
    
    .researcher-name {
      font-size: 2rem;
      font-weight: 700;
      color: #0c4a6e;
      margin: 0 0 0.5rem 0;
    }
    
    .researcher-id {
      font-size: 1rem;
      color: #0369a1;
      margin: 0 0 1.5rem 0;
    }
    
    .status-buttons {
      display: flex;
      gap: 0.75rem;
      justify-content: center;
      flex-wrap: wrap;
    }
    
    .status-btn {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 999px;
      font-family: 'Cairo', sans-serif;
      font-weight: 600;
      cursor: default;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .status-registered {
      background: #fef3c7;
      color: #92400e;
    }
    
    .info-section {
      background: white;
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    
    .info-section h3 {
      margin: 0 0 1.5rem 0;
      color: #0c4a6e;
      font-size: 1.25rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding-bottom: 0.75rem;
      border-bottom: 2px solid #e0f2fe;
    }
    
    .info-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1.25rem;
    }
    
    .info-item {
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
    }
    
    .info-label {
      font-weight: 600;
      color: #0369a1;
      font-size: 0.9rem;
    }
    
    .info-value {
      color: #1e293b;
      font-size: 1.05rem;
    }
    
    .supervisors-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    
    .supervisors-list li {
      padding: 0.75rem;
      background: #f0f9ff;
      border-radius: 8px;
      margin-bottom: 0.5rem;
      color: #0c4a6e;
      font-weight: 500;
    }
    
    /* المصروفات */
    .fees-section {
      background: white;
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    
    .fees-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1.25rem;
      margin-bottom: 1.5rem;
    }
    
    .fees-card {
      background: #f8fafc;
      padding: 1.25rem;
      border-radius: 10px;
      border: 1px solid #e2e8f0;
    }
    
    .year-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.85rem;
      background: #fff;
      border-radius: 8px;
      margin-bottom: 0.65rem;
      border: 1px solid #e5e7eb;
      transition: all 0.2s;
    }
    
    .year-item:hover {
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      padding: 0.4rem 0.85rem;
      border-radius: 999px;
      font-size: 0.9rem;
      font-weight: 600;
    }
    
    .badge-paid {
      background: #dcfce7;
      color: #166534;
      border: 1px solid #bbf7d0;
    }
    
    .badge-unpaid {
      background: #fef2f2;
      color: #991b1b;
      border: 1px solid #fecaca;
    }
    
    .delete-year-btn {
      padding: 0.5rem 1rem;
      background: #fee2e2;
      color: #991b1b;
      border: 1px solid #fecaca;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.85rem;
      font-weight: 600;
      transition: all 0.2s;
      font-family: 'Cairo', sans-serif;
    }
    
    .delete-year-btn:hover {
      background: #fecaca;
      transform: scale(1.05);
    }
    
    @media (max-width: 768px) {
      .info-grid, .fees-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>

<header>
  <div class="header-container">
    <div class="brand">
      <div class="brand-logo">
        <img src="{% static 'core/img/faculty_logo.png' %}" alt="شعار جامعة بنها">
      </div>
      <div class="brand-text">
        <h1>تفاصيل الباحث</h1>
        <p>كلية علوم الرياضة - جامعة بنها</p>
      </div>
    </div>
     <div class="user-profile" {% if not user.is_superuser %}style="cursor: default;" {% endif %}>
                {% if user.is_superuser %}
                <span class="user-name">د. أحمد خليل</span>
                <img src="{% static 'core/img/admin.png' %}" alt="الملف الشخصي" class="user-avatar">
                {% else %}
                {% if user.department_user %}
                <span class="user-name">{{ user.department_user.department.name }}</span>
                {% else %}
                <span class="user-name">{{ user.username }}</span>
                {% endif %}
                {% endif %}
                <a href="{% url 'frontend_logout' %}" class="btn btn-secondary" style="margin-right:10px;">
                    <i class="ri-logout-box-r-line"></i> خروج
                </a>
      </div>
  </div>
</header>

<main>
  <!-- Header الباحث بالشكل القديم الأحلى -->
  <div class="researcher-header">
    <div class="researcher-avatar">{{ research.researcher_name|slice:":1" }}</div>
    <h2 class="researcher-name">{{ research.researcher_name }}</h2>
    <p class="researcher-id">رقم القيد: {{ research.id }}</p>
    
    <div class="status-buttons">
      {% if research.status == "REGISTERED" %}
        <span class="status-btn status-registered">
          <i class="ri-loader-2-line"></i> مسجل
        </span>
      {% elif research.status == "DISCUSSED" %}
        <span class="status-btn" style="background: #dcfce7; color: #166534;">
          <i class="ri-check-line"></i> ناقش
        </span>
      {% elif research.status == "DISMISSED" %}
        <span class="status-btn" style="background: #fee2e2; color: #991b1b;">
          <i class="ri-user-unfollow-line"></i> مفصول
        </span>
      {% endif %}
      
      <span class="status-btn" style="background: {% if research.degree == 'PHD' %}#dbeafe{% else %}#e0e7ff{% endif %}; color: {% if research.degree == 'PHD' %}#1e40af{% else %}#4338ca{% endif %};">
        {{ research.get_degree_display }}
      </span>
      
      {% if research.researcher_type == "ASSISTANT" %}
        <span class="status-btn" style="background: #fed7aa; color: #9a3412;">
          <i class="ri-user-star-line"></i> معيد
        </span>
      {% else %}
        <span class="status-btn" style="background: #bfdbfe; color: #1e40af;">
          <i class="ri-user-line"></i> باحث
        </span>
      {% endif %}
    </div>
  </div>

  <div style="max-width: 1000px; margin: 0 auto; padding: 0 1rem;">
    <!-- أزرار التحكم -->
    <div style="display: flex; gap: 0.75rem; justify-content: center; margin-bottom: 1.5rem; flex-wrap: wrap;">
      <a href="{% url 'researchers_page' %}" class="btn btn-secondary">
        <i class="ri-arrow-right-line"></i> رجوع
      </a>
      <a href="{% url 'edit_research' research.id %}" class="btn btn-primary">
        <i class="ri-pencil-line"></i> تعديل
      </a>
      <button type="button" onclick="if(confirm('هل أنت متأكد من حذف هذا الباحث؟\n\n⚠️ سيتم حذف كل بياناته نهائياً!')) window.location.href='{% url 'delete_research' research.id %}'" class="btn" style="background: #dc2626; color: white;">
        <i class="ri-delete-bin-line"></i> حذف الباحث
      </button>
    </div>

    <!-- معلومات البحث -->
    <div class="info-section">
      <h3><i class="ri-file-text-line"></i> معلومات البحث</h3>
      
      {% if research.title %}
      <div class="info-item" style="grid-column: 1/-1; margin-bottom: 1.25rem;">
        <span class="info-label">عنوان الرسالة</span>
        <span class="info-value">{{ research.title }}</span>
      </div>
      {% endif %}
      
      <div class="info-grid">
        <div class="info-item">
          <span class="info-label">القسم</span>
          <span class="info-value">{% if research.department %}{{ research.department.name }}{% else %}—{% endif %}</span>
        </div>
        
        <div class="info-item">
          <span class="info-label">رقم الهاتف</span>
          <span class="info-value">{% if research.phone %}{{ research.phone }}{% else %}—{% endif %}</span>
        </div>
      </div>
    </div>

    <!-- التواريخ المهمة -->
    <div class="info-section">
      <h3><i class="ri-calendar-line"></i> التواريخ المهمة</h3>
      <div class="info-grid">
        <div class="info-item">
          <span class="info-label">تاريخ التسجيل</span>
          <span class="info-value">{% if research.registration_date %}{{ research.registration_date|date:"d/m/Y" }}{% else %}—{% endif %}</span>
        </div>
        
        <div class="info-item">
          <span class="info-label">تاريخ الإطار</span>
          <span class="info-value">{% if research.frame_date %}{{ research.frame_date|date:"d/m/Y" }}{% else %}—{% endif %}</span>
        </div>
        
        <div class="info-item">
          <span class="info-label">تاريخ موافقة الجامعة</span>
          <span class="info-value">{% if research.university_approval_date %}{{ research.university_approval_date|date:"d/m/Y" }}{% else %}—{% endif %}</span>
        </div>
      </div>
    </div>

    <!-- معلومات إضافية -->
    <div class="info-section">
      <h3><i class="ri-information-line"></i> معلومات إضافية</h3>
      <div class="info-grid">
        <div class="info-item">
          <span class="info-label">تاريخ الإضافة</span>
          <span class="info-value">{{ research.created_at|date:"d/m/Y" }}</span>
        </div>
        
        <div class="info-item">
          <span class="info-label">آخر تحديث</span>
          <span class="info-value">{{ research.updated_at|date:"d/m/Y H:i" }}</span>
        </div>
      </div>
    </div>

    <!-- المشرفون -->
    <div class="info-section">
      <h3><i class="ri-user-star-line"></i> المشرفون ({{ supervisors|length }})</h3>
      <ul class="supervisors-list">
        {% for sup in supervisors %}
          <li>
            <i class="ri-user-fill"></i> د. {{ sup.name }}
            {% if sup.department %}<span style="color: #64748b;"> • {{ sup.department.name }}</span>{% endif %}
          </li>
        {% empty %}
          <li style="color: #94a3b8;">لا يوجد مشرفين</li>
        {% endfor %}
      </ul>
    </div>

    <!-- المصروفات السنوية -->
    <div class="fees-section">
      <h3 style="margin: 0 0 1.5rem 0; color: #0c4a6e; font-size: 1.25rem;">
        <i class="ri-money-dollar-circle-line"></i> إدارة المصروفات السنوية
      </h3>

      <div class="fees-grid">
        <!-- تبديل حالة سنة -->
        <div class="fees-card">
          <label style="font-weight: 600; display: block; margin-bottom: 0.75rem; color: #0369a1;">
            <i class="ri-refresh-line"></i> اختر السنة
          </label>
          <select id="feesYearSelect" class="form-control" style="margin-bottom: 1rem;">
            {% for p in payments %}
              <option value="{{ p.year }}">{{ p.year }}</option>
            {% endfor %}
          </select>

          <div id="feesStatusBadge" style="margin-bottom: 1rem;"></div>

          <button class="btn btn-primary" type="button" onclick="toggleFees()" style="width: 100%;">
            <i class="ri-refresh-line"></i> تبديل الحالة
          </button>
        </div>

        <!-- إضافة سنة جديدة -->
        <div class="fees-card">
          <label style="font-weight: 600; display: block; margin-bottom: 0.75rem; color: #0369a1;">
            <i class="ri-add-circle-line"></i> إضافة سنة جديدة
          </label>
          <div style="display: flex; gap: 0.5rem;">
            <input id="addYearInput" type="number" class="form-control" placeholder="مثال: 2026" min="2000" max="2100">
            <button class="btn btn-secondary" type="button" onclick="addFeesYear()">
              <i class="ri-add-line"></i> إضافة
            </button>
          </div>
        </div>
      </div>

      <!-- قائمة السنوات -->
      <div>
        <strong style="color: #0c4a6e; font-size: 1.05rem;">السنوات المسجلة:</strong>
        <div id="yearsList" style="margin-top: 1rem;">
          {% for p in payments %}
            <div class="year-item">
              <span class="badge {% if p.is_paid %}badge-paid{% else %}badge-unpaid{% endif %}">
                {{ p.year }} — {% if p.is_paid %}<i class="ri-check-line"></i> دفع{% else %}<i class="ri-close-line"></i> لم يدفع{% endif %}
              </span>
              <button class="delete-year-btn" onclick="deleteFeesYear({{ p.year }})">
                <i class="ri-delete-bin-line"></i> حذف
              </button>
            </div>
          {% empty %}
            <p style="color: #94a3b8; text-align: center; padding: 2rem 0;">لا يوجد سنوات مسجلة بعد</p>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
</main>

<footer>
  <p>&copy; 2025 كلية علوم الرياضة - جامعة بنها. جميع الحقوق محفوظة.</p>
</footer>

<script>
function getCookie(name) {
  const value = `; ${document.cookie}`;
  const parts = value.split(`; ${name}=`);
  if (parts.length === 2) return parts.pop().split(';').shift();
  return "";
}

const RESEARCH_ID = {{ research.id }};
const csrftoken = getCookie("csrftoken");

const initialMap = {};
{% for p in payments %}
initialMap["{{ p.year }}"] = {{ p.is_paid|yesno:"true,false" }};
{% endfor %}

function renderBadge(year){
  const paid = initialMap[String(year)] === true;
  const el = document.getElementById("feesStatusBadge");
  if (paid){
    el.innerHTML = `<span class="badge badge-paid"><i class="ri-checkbox-circle-fill"></i> ${year}: مدفوع</span>`;
  } else {
    el.innerHTML = `<span class="badge badge-unpaid"><i class="ri-close-circle-fill"></i> ${year}: لم يدفع</span>`;
  }
}

function refreshYearsList(){
  const years = Object.keys(initialMap).sort((a,b)=>Number(b)-Number(a));
  const list = document.getElementById("yearsList");
  list.innerHTML = "";
  
  if (years.length === 0){
    list.innerHTML = `<p style="color: #94a3b8; text-align: center; padding: 2rem 0;">لا يوجد سنوات مسجلة بعد</p>`;
    return;
  }
  
  years.forEach(y=>{
    const paid = initialMap[y] === true;
    const cls = paid ? "badge-paid" : "badge-unpaid";
    const icon = paid ? "ri-check-line" : "ri-close-line";
    const txt = paid ? "دفع" : "لم يدفع";
    
    const div = document.createElement("div");
    div.className = "year-item";
    div.innerHTML = `
      <span class="badge ${cls}">
        ${y} — <i class="${icon}"></i> ${txt}
      </span>
      <button class="delete-year-btn" onclick="deleteFeesYear(${y})">
        <i class="ri-delete-bin-line"></i> حذف
      </button>
    `;
    list.appendChild(div);
  });
  
  const sel = document.getElementById("feesYearSelect");
  sel.innerHTML = "";
  years.forEach(y=>{
    const opt = document.createElement("option");
    opt.value = y;
    opt.textContent = y;
    sel.appendChild(opt);
  });
  if (years.length > 0) {
    sel.value = years[0];
    renderBadge(years[0]);
  }
}

function toggleFees(){
  const year = document.getElementById("feesYearSelect").value;
  if (!year) return;

  fetch(`/research/${RESEARCH_ID}/toggle-fees/${year}/`, {
    method: "POST",
    headers: {"X-CSRFToken": csrftoken, "Content-Type": "application/json"},
    body: JSON.stringify({})
  })
  .then(r => r.json())
  .then(data => {
    if (!data.success) throw new Error();
    initialMap[String(year)] = (data.status === "paid");
    renderBadge(year);
    refreshYearsList();
  })
  .catch(() => alert("حصل خطأ"));
}

function addFeesYear(){
  const year = (document.getElementById("addYearInput").value || "").trim();
  if (!year) return alert("اكتب السنة");

  const fd = new FormData();
  fd.append("year", year);

  fetch(`/research/${RESEARCH_ID}/add-fees-year/`, {
    method: "POST",
    headers: { "X-CSRFToken": csrftoken },
    body: fd
  })
  .then(r => r.json())
  .then(data => {
    if (!data.success) throw new Error();
    const y = String(data.year);
    if (!(y in initialMap)) initialMap[y] = false;
    refreshYearsList();
    document.getElementById("addYearInput").value = "";
  })
  .catch(() => alert("حصل خطأ"));
}

function deleteFeesYear(year){
  if (!confirm(`هل تريد حذف سنة ${year}؟`)) return;

  fetch(`/research/${RESEARCH_ID}/delete-fees-year/${year}/`, {
    method: "POST",
    headers: { "X-CSRFToken": csrftoken }
  })
  .then(r => r.json())
  .then(data => {
    if (!data.success) throw new Error();
    delete initialMap[String(year)];
    refreshYearsList();
  })
  .catch(() => alert("حصل خطأ"));
}

(function init(){
  const sel = document.getElementById("feesYearSelect");
  if (sel.options.length > 0) {
    renderBadge(sel.value);
    sel.addEventListener('change', function(){ renderBadge(this.value); });
  }
})();
</script>

</body>
</html>